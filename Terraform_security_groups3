locals {
  sec_groups = yamldecode(file("${path.module}/input_test_file.yaml.txt"))["sec_groups"]
}

# Helper locals to detect multi-NestedExpression+OR cases
locals {
  is_nested_group = {
    for sg in local.sec_groups : sg.display_name =>
    (
      length([
        for expr in sg.expression : expr if try(expr.resource_type, "") == "NestedExpression"
      ]) > 1 ||
      contains([
        for expr in sg.expression : try(expr.conjunction_operator, "")
      ], "OR")
    )
  }
  nested_blocks = {
    for sg in local.sec_groups : sg.display_name =>
    [for expr in sg.expression : expr if try(expr.resource_type, "") == "NestedExpression"]
  }
}

resource "nsxt_policy_group" "group" {
  for_each     = { for sg in local.sec_groups : sg.display_name => sg }
  display_name = each.value.display_name
  description  = try(each.value.id, null)
  domain       = "default"

  # ----- GROUPED CRITERIA, e.g., VCF01 -----
  dynamic "criteria" {
    for_each = local.is_nested_group[each.key] ? [1] : []
    content {
      conjunction = "OR"

      dynamic "criteria" {
        for_each = local.nested_blocks[each.key]
        content {
          conjunction = "AND"
          dynamic "condition" {
            for_each = [for sub in criteria.value.expressions : sub if try(sub.resource_type, "") == "Condition"]
            content {
              key         = condition.value.key
              member_type = condition.value.member_type
              operator    = condition.value.operator
              value       = condition.value.value
            }
          }
        }
      }
    }
  }

  # ----- SIMPLE CRITERIA -----
  dynamic "criteria" {
    for_each = local.is_nested_group[each.key] ? [] : [for expr in each.value.expression : expr]
    content {
      # Single NestedExpression (AND)
      dynamic "condition" {
        for_each = try(criteria.value.resource_type, "") == "NestedExpression"
          ? [for sub in criteria.value.expressions : sub if try(sub.resource_type, "") == "Condition"]
          : []
        content {
          key         = condition.value.key
          member_type = condition.value.member_type
          operator    = condition.value.operator
          value       = condition.value.value
        }
      }

      # Single Condition (flat tag)
      dynamic "condition" {
        for_each = try(criteria.value.resource_type, "") == "Condition" ? [criteria.value] : []
        content {
          key         = condition.value.key
          member_type = condition.value.member_type
          operator    = condition.value.operator
          value       = condition.value.value
        }
      }

      # IP addresses
      dynamic "ipaddress_expression" {
        for_each = try(criteria.value.resource_type, "") == "IPAddressExpression" ? [criteria.value] : []
        content {
          ip_addresses = criteria.value.ip_addresses
        }
      }

      # Segments
      dynamic "path_expression" {
        for_each = try(criteria.value.resource_type, "") == "PathExpression" ? [criteria.value] : []
        content {
          member_paths = criteria.value.paths
        }
      }
    }
  }
}
