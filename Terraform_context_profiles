provider "nsxt" {
  host                 = var.nsxt_host
  username             = var.nsxt_user
  password             = var.nsxt_pass
  allow_unverified_ssl = true
}

locals {
  profiles = yamldecode(file("${path.module}/context_profiles.yaml")).Context_Profile
}

resource "nsxt_policy_context_profile" "from_yaml" {
  for_each = {
    for profile in local.profiles : profile.id => profile
  }

  display_name = each.value.display_name
  description  = lookup(each.value, "description", each.value.display_name)

  dynamic "attribute" {
    for_each = each.value.attributes
    content {
      context_profile_attribute {
        attribute_type = attribute.value.key
        sub_type       = attribute.value.datatype
        value          = join(",", attribute.value.value)
      }
    }
  }
}
